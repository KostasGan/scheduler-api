<!DOCTYPE html>

<html>

<head>
    <title>Event Scheduler</title>
    <link rel="icon" href="calendar-clock-icon.png">
    <meta charset='utf-8' />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <style>
        body {
            background-color: lightgrey;
            overflow-x: hidden;
            font-family: sans-serif;
            font-size: 13px;
        }

        .container {
            margin: 5vh auto;
        }

        .btn {
            height: 30px;
            width: 150px;
            padding: 0px;
            margin: 5px auto;
        }

        label {
            margin: 0;
            padding: 0px;
            width: 100%;
        }

        input {
            font-size: 12px !important;
            height: 30px;
            width: 80%;
        }

        form {
            margin-left: auto;
            margin-right: auto;
            margin-top: 25vh;
        }

        @media screen and (max-width:768px) {
            .logo {
                flex: 100%;
                max-width: 100%;
                text-align: center;
                padding-left: 30px !important;
                margin-top: 5px;
            }
            .logout {
                align-self: center;
                margin-top: 1vh;
                margin-right: 1vh;
            }
            input {
                height: 40px !important;
            }
            form {
                margin-top: calc(25vh - 50px);
            }
        }

        .sk {
            text-align: center;
            padding: 0;
            margin: 0;
        }

        .flex-container {
            display: flex;
            flex: 100%;
            max-width: 100%;
            box-shadow: 0 1px 4px rgba(0, 0, 0, .3);
            background-color: #E8E8E8;
            align-items: center;
            justify-content: space-between;
            height: 56px;
        }

        i {
            font-size: 25px !important;
        }

        .logo {
            margin-left: 10px;
        }

        .logout {
            flex: 10%;
            text-align: end;
            padding-right: 10px;
            max-width: initial
        }

        h6 {
            align-self: center;
            font-size: 20px !important;
            margin: 0;
            padding-left: 10px;
        }

        .row label div {
            padding: 0px 15px;
        }

        .row {
            margin-left: 0px;
            margin-right: 0px;
            margin-bottom: 20px;
        }

        label {
            padding: 0px 5px;

        }

        .form-group div {
            margin: auto;
        }

        .error {
            border-color: red;
        }
        .popover{
            width: 200%;
            text-align: center;
        }
        .selectAvailability{
            margin: auto 10;
            justify-content: center;
            align-self: auto;
        }
        select{
            padding: 0px;
            margin-right: 5px;
        }
        .popover button{
            margin: auto 5px;
        }
        ul{
            list-style: none;
            padding: 0px;
        }
        h6{
            margin-bottom: 10px;
            padding-left: 0px;
        }
    </style>
    <script>
        var CLIENT_ID = '22469461720-5s0vadaqi6cli0vpe4b0268b20huc20l.apps.googleusercontent.com';
        var api = 'http://35.190.151.137:8080';
        var googleUser;

        function SignOutUser() {
            gapi.auth2.getAuthInstance().signOut();
        }

        function checkValidEmails(attendees) {
            var re = /^(([^<>()\[\]\\.:@"]+(\.[^<>()\[\]\\.:@"]+)*)|(".+"))@((\[[^0-9]{1,3}\.[^0-9]{1,3}\.[^0-9]{1,3}\.[^0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            let emails = attendees.trim().split(',');
            let wrong_emails = 0;

            emails.forEach((email) => {
                if (!re.test(String(email).toLowerCase())) {
                    wrong_emails++;
                }
                return;
            });

            if (wrong_emails !== 0) {
                document.getElementById('attendees').classList.add('error');
                document.getElementById('msg').innerHTML = 'Wrong Email';
                document.getElementById('msg').style.color = 'red';
            }
            else {
                document.getElementById('attendees').classList.remove('error');
            }
        }

        function checkAvailableTime(available_time) {
            var re = /^(?:(([01]?\d|2[0-3]):([0-5]?\d))-(([01]?\d|2[0-3]):([0-5]?\d)))$/;
            let times = available_time.trim().split(',');
            let wrong_hours = 0;

            times.forEach((times) => {
                if (!re.test(String(times).toLowerCase()) && times !== '0') {
                    wrong_hours++;
                }
                return;
            });

            if (wrong_hours !== 0) {
                document.getElementById('available_time').classList.add('error');
            }
            else {
                document.getElementById('available_time').classList.remove('error');
            }
        }

        function submitForm(data) {
            let response;
            let access_token = googleUser.getAuthResponse(true).access_token;

            let xhr = new XMLHttpRequest();
            xhr.open('POST', api + '/api/events/scheduler', true);
            xhr.timeout = 100000; // time in milliseconds
            xhr.setRequestHeader('Content-type', 'application/json');
            xhr.setRequestHeader('X-Access-Token', access_token);
            xhr.onreadystatechange = function () {
                document.querySelector('.btn').removeAttribute('disabled');

                if (xhr.readyState === 4 && xhr.status === 200) {
                    response = JSON.parse(xhr.response);

                    if (response.status === 'error') {
                        document.getElementById('resp_msg').style.color = 'red';
                        document.getElementById('resp_msg').innerHTML = response.message;
                    }
                    else if (response.data.length > 0) {
                        let message = '<h6> Suggested Dates are: </h6>';
                        let list = '';
                        response.data.forEach(function (dates) {
                            list = list + '<li>' + dates + '</li>';
                        });
                        document.getElementById('resp_msg').innerHTML = message + '<ul style="columns: 150px">' + list + '</ul>';
                        document.getElementById('resp_msg').style.color = 'black';
                    }
                    else {
                        document.getElementById('resp_msg').innerHTML = response.message;
                        document.getElementById('resp_msg').style.color = 'black';
                    }
                }

                if (xhr.readyState == 4 && xhr.status == 401) {
                    response = JSON.parse(xhr.response);

                    if (response.error_code === 'main_user_not_found'){
                        alert('Session expired. Please login again');
                        window.location.pathname = '/login.html';
                    }

                    if (response.error_code === 'unauthorized_friends' && response.data.users.length > 0) {
                        let r = confirm("Some Attendees haven't active session or permission. Do you want to send invitation ?");
                        if (r) {
                            let unauthorized = response.data.users.toString();
                            let xhr = new XMLHttpRequest();
                            xhr.open('POST',
                                api + '/api/user/invite', true);
                            xhr.timeout = 15000; // time in milliseconds
                            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                            xhr.setRequestHeader('X-Access-Token', access_token);
                            xhr.onreadystatechange = function () {
                                if (xhr.readyState == 4 && xhr.status == 200) {
                                    response = JSON.parse(xhr.response);
                                    document.getElementById('resp_msg').innerHTML = response.message;
                                }
                            }
                            xhr.send('email_list=' + unauthorized);
                        }
                    }
                }
            };
            xhr.ontimeout = function (e) {
                document.getElementById('resp_msg').style.color = 'red';
                document.getElementById('resp_msg').innerHTML = 'Huston we have a problem...! Try again later.';
            };
            xhr.send(JSON.stringify(data));
        }

        function handleClientLoad() {
            gapi.load('auth2', () => {
                gapi.auth2.init({
                    'client_id': CLIENT_ID
                }).then((googleAuth) => {
                    let cookie = document.cookie;
                    let validCookie = cookie.indexOf('G_AUTH=true') != -1;

                    if (cookie && validCookie && googleAuth.isSignedIn.get()) {
                        googleUser = googleAuth.currentUser.get();
                    }
                    else {
                        gapi.auth2.getAuthInstance().signOut();
                        window.location.pathname = '/login.html';
                    }
                }).catch((e) => {
                    console.log(e)
                });
            }, (e) => {
                console.log(e);
            });
        };
    </script>
</head>

<body>
    <div class="flex-container">
        <div class="logo">
            <img src="calendar-clock-icon.png" width="50" height="50">
        </div>
        <div class="d-none d-md-block">
            <h6>Event-Scheduler</h6>
        </div>
        <div class="logout" onclick="SignOutUser()">
            <a href="/login.html" style="color:black">
                <i class="fa fa-sign-out"></i>
            </a>
        </div>
    </div>
    <div class="container">
        <form id="form1" class="col-sm-10" autocomplete="off">
            <div class="form-group row">
                <div class="col-12 col-sm-6">
                    <label for="event_date"> Event Date </label>
                    <input id="event_date" class="form-control" required>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-12 col-sm-6">
                    <label for="duration"> Event Duration </label>
                    <input type="number" id="duration" class="form-control" min="10" max="300" step="5" required>
                    <small for="duration" class="text-muted">Must be in minutes</small>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-12 col-sm-6">
                    <label for="available_time"> Available Time </label>
                    <input type="text" id="available_time" class="form-control" required>
                    <small for="available_time" class="text-muted">eg."8:00-14:00,0,...". Zero for free days</small>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-12 col-sm-6">
                    <label for="attendees"> Attendees </label>
                    <input type="text" id="attendees" class="form-control" required>
                    <small for="attendees" class="text-muted">eg. 'test@test.com,test@test.com'</small>
                    <div>
                        <div id="msg"></div>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <div class="sk col">
                    <button type="submit" class="btn btn-primary">Submit</button>
                </div>
            </div>
            <div class="form-group msg row">
                <div class="sk col">
                    <div id="resp_msg"></div>
                </div>
            </div>
        </form>
    </div>
    <footer>
        <script async defer src="https://apis.google.com/js/platform.js?onload=handleClientLoad"></script>
        <script>
            let event_start;
            let event_end;
            let selectHour = '<option></option>';
            let selectMin = '<option></option>';
            (function () {
                for (i = 0; i < 24 ; i++){;
                    if (i < 10){
                        selectHour = selectHour + "<option class='select' value='"+ i +"'>0"+ i + '</option>'
                    } else {
                        selectHour = selectHour + "<option class='select' value='"+ i +"'>"+ i + '</option>'
                    }
                }
                for(i=0; i < 60; i+=5){
                    if (i < 10){
                        selectMin = selectMin + "<option value='"+ i +"'>0"+ i + '</option>'
                    } else {
                        selectMin = selectMin + "<option value='"+ i +"'>"+ i + '</option>'
                    }
                }
            })()

            $('#available_time').popover({
                'title': 'Select availability time!',
                "html": true,
                'content': "<div class='row selectAvailability'> <b style='margin:auto' class='col'>From</b> <select id='startHour' class='col custom-select'>" + selectHour + "</select> <select id='startMin' class='col custom-select'>" + selectMin + "</select> </div>" + 
                            "<div class='row selectAvailability'> <p style='margin:auto' class='col'> <b>To</b></p> <select id='endHour' class='col custom-select' disabled>" + selectHour + "</select> <select id='endMin' class='col custom-select' disabled>" + selectMin + "</select></div>" + 
                            "<div class='row selectAvailability' style= 'margin: auto 0'> <b><p> or </p></b></div>" +
                            "<div class='row selectAvailability'><button class='btn col' id='free_day'> Free Day </button> <button class='btn col' id='clear'>Clear</button></div>",
                'placement': 'bottom'
            });

            $('#event_date').daterangepicker({
                'locale': {
                    'format': 'DD-MM-YYYY',
                    'separator': ' - ',
                },
                'opens': 'left',
                'minDate': new moment()
            }, function (start, end, label) {
                event_start = start.format('YYYY-MM-DD');
                event_end = end.format('YYYY-MM-DD');
            });

            $('input:not(#available_time)').on('click focus', function() {
                $('#available_time').popover('hide');
            });
            $('button:not(#available_time)').on('click', function() {
                $('#available_time').popover('hide');
            });

            $('#available_time').on('shown.bs.popover', function(event) {
                $('#startHour').on('change', function (event) {
                    let disabledOptions = $('#endHour option:disabled');
                    
                    if (disabledOptions.length > 0 ) {
                        for(i = 0 ; i < disabledOptions.length; i++){
                            let index = (disabledOptions[i].index) + 1;
                            $('#endHour option:nth-child(' + index + ')').prop('disabled', false);
                        }
                    }

                    let val = parseInt($('#startHour option:selected').val());

                    if (val !== 23){
                        for (i = 0; i <= val+1; i++) {
                            $('#endHour option:nth-child(' + i + ')').prop('disabled', true);
                        }
                    } else {
                        $('#endHour option:nth-child(' + (val+2) + ')').prop('disabled', true);
                    }
                });
                
                $('#free_day').on('click', function(event) {
                    let availability = $('#available_time').val();
                        
                    if (availability !== ''){
                        let newVal = availability +  ',' + '0';
                        $('#available_time').val(newVal)
                    } else {
                        let newVal = '0';
                        $('#available_time').val(newVal);
                    }
                    $('#available_time').popover('hide');
                });

                $('#clear').on('click', function(event) {
                    $('#available_time').val('');
                    $('#available_time').popover('hide');
                });

                $('select').on('change', function (event) {
                    
                    let startVal = $('#startHour option:selected').text();
                    let startMinVal = $('#startMin option:selected').text();
                    let endVal = $('#endHour option:selected').text();
                    let endMinVal = $('#endMin option:selected').text();
                    var newVal = '';
                    
                    if(startVal !== '' && startMinVal !== ''){
                        $('#endHour').prop('disabled', false);
                        $('#endMin').prop('disabled', false);
                    }

                    if (startVal !== '' && startMinVal !== '' && endVal !== '' && endMinVal !== '') {
                        let availability = $('#available_time');
                        let availabilityText = availability.val()

                        if (availabilityText.indexOf('00:00-00:00') > -1) {
                            availabilityText.replace('00:00-00:00', '');
                            availability.val(availabilityText);
                        } else if (availabilityText !== '' ){
                            newVal = availabilityText + ',' + startVal.trim() + ':' + startMinVal.trim() + '-' + endVal.trim() + ':' + endMinVal.trim();
                        } else {
                            newVal = startVal.trim() + ':' + startMinVal.trim() + '-' + endVal.trim() + ':' + endMinVal.trim();
                        }

                        if(newVal.indexOf('00:00-00:00') < 0 ){
                            availability.val(newVal);
                        }
                        $('#available_time').popover('hide');
                    }
                });
            });

            document.getElementById('form1').addEventListener('submit', function (event) {
                event.preventDefault();
                
                let available_time = document.getElementById('available_time').value;
                let attendees = document.getElementById('attendees').value;

                checkAvailableTime(available_time);
                checkValidEmails(attendees);

                if (document.getElementsByClassName('error').length > 0) {
                    return;
                }
                else {
                    let event_duration = document.getElementById('duration').value;

                    if (!event_start && !event_end) {
                        let value = document.getElementById('event_date').value;
                        let spltVal = value.split(' - ');

                        event_start = moment(spltVal[0], 'DD-MM-YYYY').format('YYYY-MM-DD').toString();
                        event_end = moment(spltVal[1], 'DD-MM-YYYY').format('YYYY-MM-DD').toString();
                    }

                    let data = {
                        event_start: event_start,
                        event_end: event_end,
                        event_duration: event_duration,
                        available_time: available_time,
                        attendees: attendees
                    };

                    document.getElementById('resp_msg').innerHTML = '';
                    document.querySelector('.btn').setAttribute('disabled', true);
                    submitForm(data);
                }
            }, true);
        </script>
    </footer>
</body>

</html>